<%= content_tag :div, id: 'product_id', data: { id: @product.id } do %> <% end %>
<%# 给 js 一个标识符 %>
<div class="container">
  <div class="row flex-nowrap justify-content-center content-container" style="padding:40px; background-color: #fff; width: min-content;">
    <div class="col-auto" style="padding:10px">
      <%= image_tag(@product.product_url, class: "product_pic_big") %>
    </div>
    <div class="col-auto d-flex flex-column" style="padding:10px">
      <div class="row">
        <p style="font-size:24px;padding-bottom:0px;margin-bottom:0px">
          <%= @product.product_name %>
        </p>
        <p style = "color:grey;margin-top:0px;">
          <%= @product.description %>
        </p>
        <p id="price_field" style="font-size:20px; font-weight:bold; font-family:Microsoft Yahei; color:orange;">
          <br>
          <%# 占位，利用 js 修改  %>
        </p>
      </div>
      <div class="row flex-grow-1">
        <%= form_with(model: @cart_item) do |form| %>
          <div class="col d-flex flex-column" style="width:430px; height:100%">
            <div class="row">
              <%= form.label :product_type_id, '商品类型', { class: "col-4 col-form-label"} %>
              <div class="col-8", id="type_field">
                <%= form.select :product_type_id, @product.product_types.map{ |type| [type.product_type_name, type.id]}, { prompt: "请选择商品类型"}, { class: 'form-control', placeholder: "col-form-label-sm"} do %>
                  <%= @product.product_types.each do |p|  %>
                    <%= tag.option(p.product_type_name, value: p.id, class:"") %>;
                  <% end %>
                <% end %>
              </div>
            </div>
            <div class="row">
              <%= form.label :color, '颜色' , { class: "col-4 col-form-label"} %>
              <div class="col-8", id="color_field">
                <%= form.select :color, [], { prompt: "请选择商品类型"}, { class: 'form-control', placeholder: "col-form-label-sm"} %>
              </div>
            </div>
            <div class="row">
              <%= form.label :size, '尺码' , { class: "col-4 col-form-label"} %>
              <div class="col-8", id="size_field">
                <%= form.select :size, [], { prompt: "请选择商品类型"}, { class: 'form-control', placeholder: "col-form-label-sm"} %>
              </div>
            </div>
            <div class="row">
              <%= form.label :quantity, '数量' , { class: "col-4 col-form-label"} %>
              <div class="col-8">
                <%= form.number_field :quantity, min: 1, step:1, value:1, class: 'form-control' %>
              </div>
            </div>
            <div class="row mt-auto">
              <div class="col d-flex justify-content-center">
                <button type="submit" name="buy" class="btn btn-danger text-white" style="margin: 2px">
                  <i class="bi bi-box-seam-fill"></i> 立即购买
                </button>
                <button type="submit" name="cart" class="btn btn-warning text-white" style="margin: 2px">
                  <i class="bi bi-cart-check"></i> 加入购物车
                </button>
                <% if current_user.favorite?(@product) %>
                  <%= link_to product_favorite_path(@product), data: { turbo_method: :delete }, class: "btn btn-outline-warning", style: "margin: 2px"  do %>
                    <i class="bi bi-star-fill"></i> 取消收藏
                  <% end %>
                <% else %>
                  <%= link_to product_favorite_path(@product), data: { turbo_method: :post }, class: "btn btn-outline-warning" do %>
                    <i class="bi bi-star"></i> 收藏
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<script>
  // 获取表单元素
  var productId = document.getElementById("product_id").dataset.id;
  var productTypeIdField = document.getElementById('cart_item_product_type_id');
  var colorField = document.getElementById("color_field");
  var sizeField = document.getElementById("size_field");
  var priceField = document.getElementById("price_field");

  function productTypeChange() {
    console.log("product type changed")
    var selectedProductTypeId = productTypeIdField.value;
    var colorSelect = colorField.querySelector("select");
    var sizeSelect = sizeField.querySelector("select");
    if (selectedProductTypeId == "") {
      var emptyOption1 = document.createElement("option");
      var emptyOption2 = document.createElement("option");
      emptyOption1.value = "";
      emptyOption1.text = "请选择商品类型";
      emptyOption2.value = "";
      emptyOption2.text = "请选择商品类型";
      colorSelect.innerHTML = "";
      sizeSelect.innerHTML = "";
      colorSelect.appendChild(emptyOption1);
      sizeSelect.appendChild(emptyOption2);
      priceField.textContent = "￥???"
    } else {
      fetch('/products/' + productId + '/product_types/' + selectedProductTypeId + '/price')
      .then(response => response.json())
      .then(data => {
        console.log(data);
        priceField.textContent = "￥"+data;
      }).catch(error => console.error("Error:", error));

      fetch('/products/' + productId + '/product_types/' + selectedProductTypeId + '/colors')
      .then(response => response.json())
      .then(data => {
        colorSelect.innerHTML = '';
        data.forEach(function(color) {
          var option = document.createElement("option");
          option.value = color;
          option.text = color;
          option.setAttribute("class", "btn btn-primary");
          colorSelect.appendChild(option);
        });
      }).catch(error => console.error("Error:", error));

      fetch('/products/' + productId + '/product_types/' + selectedProductTypeId + '/sizes')
      .then(response => response.json())
      .then(data => {
        sizeSelect.innerHTML = '';
        data.forEach(function(size) {
          var option = document.createElement("option");
          option.value = size;
          option.text = size;
          sizeSelect.appendChild(option);
        });
      }).catch(error => console.error("Error:", error));
    }
    console.log("colorSelect.innerHTML: " + colorSelect.innerHTML)
  }

  productTypeChange();

  productTypeIdField.addEventListener('change', function() {
    productTypeChange();
  });
</script>
